---
// src/components/YandexMetrika.astro - ИСПРАВЛЕННАЯ ВЕРСИЯ
// Определяем язык из URL
const isEnglish = Astro.url.pathname.includes('/en/');
const currentLang = isEnglish ? 'en' : 'ru';

// Ваш существующий ID счетчика
const METRIKA_ID = '103737764';
---

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=103737764', 'ym');
    
    ym(103737764, 'init', {
        ssr: true, 
        webvisor: true, 
        clickmap: true, 
        ecommerce: "dataLayer", 
        accurateTrackBounce: true, 
        trackLinks: true,
        // Добавляем параметр языка
        params: {
            language: window.location.pathname.includes('/en/') ? 'en' : 'ru'
        }
    });
    
    // Отмечаем язык страницы
    ym(103737764, 'userParams', {
        language: window.location.pathname.includes('/en/') ? 'en' : 'ru'
    });
</script>
<noscript>
    <div>
        <img src="https://mc.yandex.ru/watch/103737764" style="position:absolute; left:-9999px;" alt="" />
    </div>
</noscript>
<!-- /Yandex.Metrika counter -->

<!-- Отслеживание событий - ИСПРАВЛЕННАЯ ВЕРСИЯ -->
<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function() {
    // Определяем язык из URL в браузере
    var currentLang = window.location.pathname.includes('/en/') ? 'en' : 'ru';
    
    // 1. Переключение языка
    var langSwitchers = document.querySelectorAll('a[href*="/en/"], a[href*="/ru/"]');
    langSwitchers.forEach(function(link) {
        link.addEventListener('click', function() {
            var targetLang = this.href.includes('/en/') ? 'en' : 'ru';
            if (typeof ym !== 'undefined') {
                ym(103737764, 'reachGoal', 'lang_switch_' + currentLang + '_to_' + targetLang);
                console.log('Language switch event:', currentLang, '->', targetLang);
            }
        });
    });

    // 2. Telegram контакты
    var telegramLinks = document.querySelectorAll('a[href*="t.me"], a[href*="telegram"]');
    telegramLinks.forEach(function(link) {
        link.addEventListener('click', function() {
            if (typeof ym !== 'undefined') {
                ym(103737764, 'reachGoal', 'telegram_' + currentLang);
                console.log('Telegram contact event:', currentLang);
            }
        });
    });

    // 3. Email и WhatsApp контакты
    var contactLinks = document.querySelectorAll('a[href^="mailto:"], a[href*="whatsapp"], a[href*="wa.me"]');
    contactLinks.forEach(function(link) {
        link.addEventListener('click', function() {
            var contactType = 'email';
            if (this.href.includes('whatsapp') || this.href.includes('wa.me')) {
                contactType = 'whatsapp';
            }
            if (typeof ym !== 'undefined') {
                ym(103737764, 'reachGoal', contactType + '_' + currentLang);
                console.log('Contact event:', contactType, currentLang);
            }
        });
    });

    // 4. Просмотр проектов
    var projectLinks = document.querySelectorAll('a[href*="/projects/"]');
    projectLinks.forEach(function(link) {
        link.addEventListener('click', function() {
            if (typeof ym !== 'undefined') {
                ym(103737764, 'reachGoal', 'project_view_' + currentLang);
                console.log('Project view event:', currentLang);
            }
        });
    });

    // 5. Просмотр кейсов
    var caseLinks = document.querySelectorAll('a[href*="/cases/"]');
    caseLinks.forEach(function(link) {
        link.addEventListener('click', function() {
            if (typeof ym !== 'undefined') {
                ym(103737764, 'reachGoal', 'case_view_' + currentLang);
                console.log('Case view event:', currentLang);
            }
        });
    });

    // Отладочная информация
    console.log('YandexMetrika initialized for language:', currentLang);
    console.log('ym function available:', typeof ym !== 'undefined');
});
</script>